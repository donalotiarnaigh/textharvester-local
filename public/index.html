<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Historic Graves Text Harvester</title>

    <!-- Include Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.css"
    />

    <!-- Include jQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/styles.css" />
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon" />

    <!-- Authentication Check -->
    <script>
      document.addEventListener('DOMContentLoaded', async function () {
        try {
          const response = await fetch('/api/auth/check-auth');
          if (response.ok) {
            const data = await response.json();
            if (!data.loggedIn) {
              window.location.href = 'login.html';
            }
          } else {
            window.location.href = 'login.html';
          }
        } catch (error) {
          console.error('Auth check error:', error);
          window.location.href = 'login.html';
        }
      });
    </script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="index.html">
        <img
          src="/images/logo.png"
          alt="Historic Graves Logo"
          style="height: 50px; margin-right: 10px"
        />
        Historic Graves Text Harvester
      </a>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="results.html">View Previous Results</a>
          </li>
          <li class="nav-item" id="nav-register">
            <a class="nav-link" href="register.html">Register</a>
          </li>
          <li class="nav-item" id="nav-login">
            <a class="nav-link" href="login.html">Login</a>
          </li>
          <li class="nav-item" id="nav-logout" style="display: none">
            <a id="logoutButton" class="nav-link" href="#">Logout</a>
          </li>
        </ul>
      </div>
    </nav>

    <div class="content-wrap">
      <div class="container">
        <!-- Instructions Box -->
        <div class="card instructions">
          <div class="card-body">
            <h5 class="card-title">How to Use the Text Harvester</h5>
            <p class="card-text">
              To upload files, drag and drop your JPEG images or PDF documents
              into the drop zone or click to select files. Once uploaded, your
              files will be processed for text extraction. You can track
              progress on the processing page. When processing is complete,
              you'll be redirected to the results page.
            </p>
            <small>
              Supported file types: .jpeg, .jpg, .pdf. Maximum file size: 100MB
              per file.
            </small>
            <small>
              Note: Each page of uploaded PDFs will be processed as a separate
              image.
            </small>
            <small>
              Ensure PDFs are not encrypted as encryption will prevent
              successful processing.
            </small>
          </div>
        </div>

        <!-- Drop Zone for File Upload -->
        <form action="/upload" class="dropzone" id="uploadForm">
          <div class="dz-message">
            Drop files here or click to upload (JPEG or PDF).
          </div>
        </form>

        <!-- Submit Button -->
        <button id="submitFiles" class="btn btn-success btn-block">
          Submit Files
        </button>
      </div>
    </div>

    <footer class="footer">
      Â© 2024 Historic Graves Project. For more info, contact
      <a href="mailto:daniel@textharvester.ie">daniel@textharvester.ie</a> or
      <a href="https://www.historicgraves.ie" target="_blank"
        >Historic Graves</a
      >
      website.
    </footer>

    <script type="module">
      import { initDropzone } from '/js/modules/index/dropzone.js';
      initDropzone();
    </script>
    <script>
      // Check if user is logged in
      document.addEventListener('DOMContentLoaded', async function () {
        try {
          const response = await fetch('/api/auth/check-auth');
          if (response.ok) {
            const data = await response.json();
            if (data.loggedIn) {
              document.getElementById('nav-register').style.display = 'none';
              document.getElementById('nav-login').style.display = 'none';
              document.getElementById('nav-logout').style.display = 'block';
              console.log('Logged in, showing logout button');
            } else {
              console.log('Not logged in');
            }
          }
        } catch (error) {
          console.error('Auth check error:', error);
        }
      });

      // Logout functionality
      document
        .getElementById('logoutButton')
        .addEventListener('click', async function (e) {
          e.preventDefault(); // Prevent default action to handle it with JavaScript
          try {
            const response = await fetch('/api/auth/logout', {
              method: 'POST',
            });
            if (response.ok) {
              window.location.href = 'login.html';
            }
          } catch (error) {
            console.error('Logout error:', error);
          }
        });
    </script>
  </body>
</html>
